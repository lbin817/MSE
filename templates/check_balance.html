{% extends "base.html" %}

{% block title %}조별 잔여금액 확인 - 예산 관리 시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-wallet me-2"></i>조별 잔여금액 확인
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>조 정보 입력
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">조 번호</label>
                        <select name="team_name" class="form-select" required>
                            <option value="">조를 선택하세요</option>
                            {% for team in teams %}
                            <option value="{{ team.name }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">조장 이름</label>
                        <input type="text" name="leader_name" class="form-control" placeholder="조장 이름을 입력하세요" required>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">확인</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>안내사항
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>조장 이름을 정확히 입력해주세요</li>
                    <li><i class="fas fa-check text-success me-2"></i>학과지원사업과 학생지원사업 잔여금액을 확인할 수 있습니다</li>
                    <li><i class="fas fa-check text-success me-2"></i>승인된 구매내역만 차감됩니다</li>
                    <li><i class="fas fa-check text-success me-2"></i>실시간으로 업데이트됩니다</li>
                </ul>
                
                <hr>
                
                <h6><i class="fas fa-money-bill-wave me-2"></i>예산 구분</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-graduation-cap text-primary me-2"></i><strong>학과지원사업:</strong> 재료비, 시험분석비</li>
                    <li><i class="fas fa-user-graduate text-success me-2"></i><strong>학생지원사업:</strong> 재료비만</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% if balance_info %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>{{ balance_info.team_name }} 잔여금액 현황
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-graduation-cap me-2"></i>학과지원사업
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">총 예산</small>
                                        <h5 class="text-primary">{{ "{:,}".format(balance_info.department_budget) }}원</h5>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">잔여금액</small>
                                        <h5 class="text-success">{{ "{:,}".format(balance_info.department_remaining) }}원</h5>
                                    </div>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-primary" style="width: {{ (balance_info.department_remaining / balance_info.department_budget * 100) }}%"></div>
                                </div>
                                <small class="text-muted">잔여율: {{ "%.1f"|format(balance_info.department_remaining / balance_info.department_budget * 100) }}%</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-graduate me-2"></i>학생지원사업
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">총 예산</small>
                                        <h5 class="text-success">{{ "{:,}".format(balance_info.student_budget) }}원</h5>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">잔여금액</small>
                                        <h5 class="text-success">{{ "{:,}".format(balance_info.student_remaining) }}원</h5>
                                    </div>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" style="width: {{ (balance_info.student_remaining / balance_info.student_budget * 100) }}%"></div>
                                </div>
                                <small class="text-muted">잔여율: {{ "%.1f"|format(balance_info.student_remaining / balance_info.student_budget * 100) }}%</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>총 예산</h6>
                            <h4 class="mb-0">{{ "{:,}".format(balance_info.department_budget + balance_info.student_budget) }}원</h4>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-wallet me-2"></i>총 잔여금액</h6>
                            <h4 class="mb-0">{{ "{:,}".format(balance_info.department_remaining + balance_info.student_remaining) }}원</h4>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <small class="text-muted">
                        조장: {{ balance_info.leader_name }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 구매내역 리스트 -->
{% if balance_info.purchases or balance_info.multi_purchases %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>구매내역
                </h5>
            </div>
            <div class="card-body">
                <!-- 일반 구매내역 -->
                {% if balance_info.purchases %}
                <h6 class="mb-3"><i class="fas fa-list me-2"></i>일반 구매내역</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>품목명</th>
                                <th>수량</th>
                                <th>비용</th>
                                <th>쇼핑몰</th>
                                <th>예산유형</th>
                                <th>구매일시</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for purchase in balance_info.purchases %}
                            <tr>
                                <td>
                                    <div class="text-break">{{ purchase.item_name }}</div>
                                    {% if purchase.attachment_filename %}
                                    <small class="text-muted">
                                        <i class="fas fa-paperclip"></i> 견적서 첨부됨
                                    </small>
                                    {% endif %}
                                </td>
                                <td>{{ purchase.quantity }}개</td>
                                <td class="text-primary"><strong>{{ "{:,}".format(purchase.estimated_cost) }}원</strong></td>
                                <td>{{ purchase.store }}</td>
                                <td>
                                    {% if purchase.budget_type == 'department' %}
                                        <span class="badge bg-primary">학과지원사업</span>
                                    {% elif purchase.budget_type == 'student' %}
                                        <span class="badge bg-success">학생지원사업</span>
                                    {% else %}
                                        <span class="badge bg-secondary">미선택</span>
                                    {% endif %}
                                </td>
                                <td>{{ purchase.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                
                <!-- 다중 품목 구매내역 -->
                {% if balance_info.multi_purchases %}
                <hr>
                <h6 class="mb-3"><i class="fas fa-list-alt me-2"></i>다중 품목 구매내역</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>쇼핑몰</th>
                                <th>총 금액</th>
                                <th>품목 수</th>
                                <th>예산유형</th>
                                <th>구매일시</th>
                                <th>상세보기</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for multi_purchase in balance_info.multi_purchases %}
                            <tr>
                                <td>{{ multi_purchase.store }}</td>
                                <td class="text-primary"><strong>{{ "{:,}".format(multi_purchase.total_cost) }}원</strong></td>
                                <td><span class="badge bg-info">{{ multi_purchase.items|length }}개</span></td>
                                <td>
                                    {% if multi_purchase.budget_type == 'department' %}
                                        <span class="badge bg-primary">학과지원사업</span>
                                    {% elif multi_purchase.budget_type == 'student' %}
                                        <span class="badge bg-success">학생지원사업</span>
                                    {% else %}
                                        <span class="badge bg-secondary">미선택</span>
                                    {% endif %}
                                </td>
                                <td>{{ multi_purchase.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            data-bs-toggle="collapse" data-bs-target="#multi-items-{{ multi_purchase.id }}">
                                        <i class="fas fa-eye"></i> 보기
                                    </button>
                                </td>
                            </tr>
                            <!-- 품목 상세 정보 (접을 수 있음) -->
                            <tr class="collapse" id="multi-items-{{ multi_purchase.id }}">
                                <td colspan="6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list me-2"></i>품목 상세
                                                {% if multi_purchase.attachment_filename %}
                                                <small class="text-muted ms-2">
                                                    <i class="fas fa-paperclip"></i> 견적서 첨부됨
                                                </small>
                                                {% endif %}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>품목명</th>
                                                            <th>수량</th>
                                                            <th>단가</th>
                                                            <th>소계</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for item in multi_purchase.items %}
                                                        <tr>
                                                            <td>{{ item.item_name }}</td>
                                                            <td>{{ item.quantity }}개</td>
                                                            <td>{{ "{:,}".format(item.unit_price) }}원</td>
                                                            <td><strong>{{ "{:,}".format(item.quantity * item.unit_price) }}원</strong></td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                    <tfoot>
                                                        <tr class="table-info">
                                                            <th colspan="3">총계</th>
                                                            <th>{{ "{:,}".format(multi_purchase.total_cost) }}원</th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}
